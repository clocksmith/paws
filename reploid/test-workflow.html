<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reploid Workflow Test</title>
    <link rel="stylesheet" href="boot/style.css">
    <style>
        body {
            background: #0a0a14;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            padding: 20px;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #4ec9b0;
            margin-bottom: 20px;
        }

        .test-section {
            background: rgba(40, 40, 40, 0.6);
            border: 2px solid #333;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-section h2 {
            color: #4ec9b0;
            font-size: 16px;
            margin: 0 0 12px 0;
        }

        button {
            padding: 10px 20px;
            background: #4ec9b0;
            color: #000;
            border: none;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #6ee7ce;
        }

        button:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
        }

        .log {
            background: #1e1e1e;
            padding: 12px;
            margin-top: 12px;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
        }

        .log-entry {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .log-entry.info { color: #4ec9b0; }
        .log-entry.warn { color: #ffc107; }
        .log-entry.error { color: #ff4444; }

        .status {
            background: rgba(78, 201, 176, 0.1);
            border-left: 3px solid #4ec9b0;
            padding: 12px;
            margin-top: 12px;
        }

        .status strong {
            color: #4ec9b0;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            background: #1e1e1e;
            border: 1px solid #333;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>◈ Reploid Workflow Test</h1>

        <div class="test-section">
            <h2>1. System Status</h2>
            <button onclick="checkModules()">Check Modules</button>
            <button onclick="checkMCPServers()">Check MCP Servers</button>
            <div class="status" id="system-status">
                <strong>Status:</strong> <span id="status-text">Ready to test</span>
            </div>
        </div>

        <div class="test-section">
            <h2>2. Start Workflow</h2>
            <label>Goal:</label>
            <input type="text" id="goal-input" placeholder="Enter a goal (e.g., 'Add a hello world function to utils.js')" value="Add a hello world function to utils.js">
            <br><br>
            <button onclick="startWorkflow()">Start Workflow</button>
            <button onclick="getWorkflowStatus()">Get Status</button>
        </div>

        <div class="test-section">
            <h2>3. Approvals</h2>
            <button onclick="approveContext()" id="approve-context-btn" disabled>Approve Context</button>
            <button onclick="rejectContext()

" id="reject-context-btn" disabled>Reject Context</button>
            <button onclick="approveProposal()" id="approve-proposal-btn" disabled>Approve Proposal</button>
            <button onclick="rejectProposal()" id="reject-proposal-btn" disabled>Reject Proposal</button>
        </div>

        <div class="test-section">
            <h2>4. Event Log</h2>
            <div class="log" id="event-log"></div>
        </div>
    </div>

    <script type="module">
        // Import module loader
        import { loadModulePreset } from './upgrades/core/boot-module-loader.js';

        let modules = null;
        let currentSessionId = null;

        // Log function
        function log(message, level = 'info') {
            const logDiv = document.getElementById('event-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${level}] ${message}`);
        }

        function updateStatus(text) {
            document.getElementById('status-text').textContent = text;
        }

        // Load modules on startup
        async function initSystem() {
            try {
                log('Loading Reploid modules...', 'info');
                updateStatus('Loading modules...');

                // Load minimal-rsi preset
                modules = await loadModulePreset('minimal-rsi');

                log(`Loaded ${Object.keys(modules).length} modules`, 'info');
                updateStatus(`System ready (${Object.keys(modules).length} modules loaded)`);

                // Subscribe to FSM events
                if (modules.EventBus) {
                    modules.EventBus.on('fsm:state:changed', (data) => {
                        log(`State changed: ${data.oldState} → ${data.newState}`, 'info');
                        updateApprovalButtons(data.newState);
                    });

                    modules.EventBus.on('status:updated', (data) => {
                        log(`Status: ${data.state} - ${data.detail}`, 'info');
                    });
                }

            } catch (error) {
                log(`Failed to load modules: ${error.message}`, 'error');
                updateStatus('Error loading modules');
                console.error(error);
            }
        }

        function updateApprovalButtons(state) {
            const contextApprove = document.getElementById('approve-context-btn');
            const contextReject = document.getElementById('reject-context-btn');
            const proposalApprove = document.getElementById('approve-proposal-btn');
            const proposalReject = document.getElementById('reject-proposal-btn');

            // Disable all by default
            contextApprove.disabled = true;
            contextReject.disabled = true;
            proposalApprove.disabled = true;
            proposalReject.disabled = true;

            if (state === 'AWAITING_CONTEXT_APPROVAL') {
                contextApprove.disabled = false;
                contextReject.disabled = false;
            } else if (state === 'AWAITING_PROPOSAL_APPROVAL') {
                proposalApprove.disabled = false;
                proposalReject.disabled = false;
            }
        }

        // Make functions global
        window.checkModules = () => {
            if (!modules) {
                log('Modules not loaded yet', 'warn');
                return;
            }

            log('=== Module Check ===', 'info');
            log(`Total modules: ${Object.keys(modules).length}`, 'info');

            const keyModules = ['SentinelFSM', 'StateManager', 'ToolRunner', 'EventBus', 'WorkflowMCPServer'];
            keyModules.forEach(mod => {
                if (modules[mod]) {
                    log(`✓ ${mod} loaded`, 'info');
                } else {
                    log(`✗ ${mod} missing`, 'error');
                }
            });
        };

        window.checkMCPServers = () => {
            if (!modules || !modules.ReploidMCPRegistry) {
                log('MCP Registry not available', 'warn');
                return;
            }

            log('=== MCP Server Check ===', 'info');
            const servers = modules.ReploidMCPRegistry.listServers();
            log(`Found ${servers.length} MCP servers:`, 'info');
            servers.forEach(server => {
                log(`  - ${server.name} (v${server.version})`, 'info');
            });
        };

        window.startWorkflow = async () => {
            if (!modules || !modules.SentinelFSM) {
                log('SentinelFSM not loaded', 'error');
                return;
            }

            const goal = document.getElementById('goal-input').value.trim();
            if (!goal) {
                log('Please enter a goal', 'warn');
                return;
            }

            try {
                log(`Starting workflow with goal: "${goal}"`, 'info');
                const result = await modules.SentinelFSM.startCycle(goal);

                if (result) {
                    log('Workflow started successfully', 'info');
                    currentSessionId = modules.SentinelFSM.getStatus().sessionId;
                } else {
                    log('Failed to start workflow', 'error');
                }
            } catch (error) {
                log(`Error starting workflow: ${error.message}`, 'error');
                console.error(error);
            }
        };

        window.getWorkflowStatus = () => {
            if (!modules || !modules.SentinelFSM) {
                log('SentinelFSM not loaded', 'error');
                return;
            }

            const status = modules.SentinelFSM.getStatus();
            log('=== Workflow Status ===', 'info');
            log(`State: ${status.state}`, 'info');
            log(`Goal: ${status.goal || 'None'}`, 'info');
            log(`Session ID: ${status.sessionId || 'None'}`, 'info');
        };

        window.approveContext = async () => {
            if (!modules || !modules.SentinelFSM) {
                log('SentinelFSM not loaded', 'error');
                return;
            }

            try {
                log('Approving context...', 'info');
                await modules.SentinelFSM.approveContext();
                log('Context approved', 'info');
            } catch (error) {
                log(`Error approving context: ${error.message}`, 'error');
            }
        };

        window.rejectContext = async () => {
            if (!modules || !modules.SentinelFSM) {
                log('SentinelFSM not loaded', 'error');
                return;
            }

            const feedback = prompt('Rejection reason:');
            if (!feedback) return;

            try {
                log(`Rejecting context: "${feedback}"`, 'info');
                await modules.SentinelFSM.rejectContext(feedback);
                log('Context rejected', 'info');
            } catch (error) {
                log(`Error rejecting context: ${error.message}`, 'error');
            }
        };

        window.approveProposal = async () => {
            if (!modules || !modules.SentinelFSM) {
                log('SentinelFSM not loaded', 'error');
                return;
            }

            try {
                log('Approving proposal...', 'info');
                await modules.SentinelFSM.approveProposal();
                log('Proposal approved', 'info');
            } catch (error) {
                log(`Error approving proposal: ${error.message}`, 'error');
            }
        };

        window.rejectProposal = async () => {
            if (!modules || !modules.SentinelFSM) {
                log('SentinelFSM not loaded', 'error');
                return;
            }

            const feedback = prompt('Rejection reason:');
            if (!feedback) return;

            try {
                log(`Rejecting proposal: "${feedback}"`, 'info');
                await modules.SentinelFSM.rejectProposal(feedback);
                log('Proposal rejected', 'info');
            } catch (error) {
                log(`Error rejecting proposal: ${error.message}`, 'error');
            }
        };

        // Initialize on load
        initSystem();
    </script>
</body>
</html>
